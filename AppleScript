(* 
bit.ly/ä¸‹è¼‰_é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥ 
GitHub.com/VirgoEros/iCloudFolderSync/blob/master/AppleScript 
*)
------------------------------âˆ é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥ âˆ----------------------------------ON.  
global iCloudMode, OpenScript, iCloudSyncMode, SyncSource, SyncSourceName, SyncDest, rsyncPath, rsyncParameter, TerminalNotifier, isDone, itemPath, itemProgress, iCloudSyncMode, firstRun, RT_Seconds, RT_Option, RT_Option_HDW, errmsg, errnbr
global iCloudSyncMode, SyncSource, SyncSourceName, SyncDest, rsyncPath, rsyncParameter, firstRun, RT_Seconds, rsyncPath, rsyncParameter, SyncSource, SyncDest, RT_Option, RT_Option_HDW, errmsg, errnbr
global OpenScript, OpenAppScript, TerminalNotifier, errmsg, errnbr

on run
	try
		tell application "Finder"
			set {button returned:iCloudMode} to Â¬
				display dialog {"è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ iCloudDrive é®¦æ­¥é¸é … å”·ğŸ’‹"} buttons Â¬
					{"å°‡æ²å¥³é°°é¸æ“‡çš„æ–‡ä»¶å¤¾é®¦æ­¥è‡³iCloudDrive", "é–‹å•Ÿè…³æœ¬", "é€€å‡º"} with title Â¬
					{"é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥"}
			
			if iCloudMode is "é–‹å•Ÿè…³æœ¬" then run script OpenScript
			if iCloudMode is "é€€å‡º" then continue quit
			
			if iCloudMode is "å°‡æ²å¥³é°°é¸æ“‡çš„æ–‡ä»¶å¤¾é®¦æ­¥è‡³iCloudDrive" then
				set {button returned:iCloudSyncMode} to Â¬
					display dialog {"è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveé¸é … å”·ğŸ’‹"} buttons Â¬
						{"é±“æ¬¡é®¦æ­¥", "å¯¦é°£é®¦æ­¥"} with title Â¬
						{"é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥"}
				
				if iCloudSyncMode is "é±“æ¬¡é®¦æ­¥" then
					set SyncSource to Â¬
						(choose folder with prompt "è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²åŒæ­¥ä¹‹ä¾†æºè³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (users folder)))
					
					set SyncSourceName to (SyncSource's name as string)
					set SyncSourceName to quoted form of SyncSourceName
					do shell script ("cd ~/Library/'Mobile Documents'/com~apple~CloudDocs ;mkdir -p " & SyncSourceName)
					set SyncDest to ("~/Library/'Mobile Documents'/com~apple~CloudDocs/" & SyncSourceName)
					
					
					set SyncSource to quoted form of POSIX path of SyncSource
					
					set rsyncPath to POSIX path of (path to me as text) & ("Contents/MacOS/rsync")
					set rsyncPath to quoted form of rsyncPath
					
					set rsyncParameter to (" -ESWPaudvxh80AX --delete --stats --exclude={.*,} ")
					
					set TerminalNotifier to POSIX path of (path to me as text) Â¬
						& {"Contents/MacOS/terminal-notifier"}
					set TerminalNotifier to quoted form of TerminalNotifier
					do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥ä¸­å”·ğŸ’‹")
					
					do shell script (rsyncPath & rsyncParameter & SyncSource & space & SyncDest)
					
					delay 1
					set isDone to false
					set itemPath to ("rsync ")
					set itemProgress to "ps ax | grep -v grep | grep " & itemPath
					repeat while isDone is false
						try
							do shell script itemProgress
							if the result contains itemPath then
								delay 1
							else
								set isDone to true
							end if
						on error
							set isDone to true
						end try
					end repeat
					if isDone is true then
						do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
						do shell script ("open " & SyncDest)
						continue quit
					end if
				end if
				if iCloudSyncMode is "å¯¦é°£é®¦æ­¥" then
					set SyncSource to Â¬
						(choose folder with prompt "è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²åŒæ­¥ä¹‹ä¾†æºè³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (users folder)))
					
					set SyncSourceName to (SyncSource's name as string)
					set SyncSourceName to quoted form of SyncSourceName
					do shell script ("cd ~/Library/'Mobile Documents'/com~apple~CloudDocs ;mkdir -p " & SyncSourceName)
					set SyncDest to ("~/Library/'Mobile Documents'/com~apple~CloudDocs/" & SyncSourceName)
					
					
					set SyncSource to quoted form of POSIX path of SyncSource
					
					set rsyncPath to POSIX path of (path to me as text) & ("Contents/MacOS/rsync")
					set rsyncPath to quoted form of rsyncPath
					
					set rsyncParameter to (" -ESWPaudvxh80AX --delete --stats --exclude={.*,} ")
					set firstRun to true
					set RT_Seconds to ("")
					set {button returned:RT_Option} to Â¬
						display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
							{"ç§’", "é­µ", "é°£ æ—¥ é€±"} with title Â¬
							{"é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥"}
					
					if RT_Option is "ç§’" then return RT_Seconds
					if RT_Option is "é­µ" then return {RT_Seconds * minutes}
					
					if RT_Option is "é°£ æ—¥ é€±" then
						set {button returned:RT_Option_HDW} to Â¬
							display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
								{"é°£", "æ—¥", "é€±"} with title Â¬
								{"é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥"}
						
						if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
						if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
						if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
						
					end if
				end if
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end run

on idle
	try
		if iCloudSyncMode is "å¯¦é°£é®¦æ­¥" then
			if firstRun then
				tell application "Finder" to display dialog {"è«‹æ²å¥³é°°é°é­é–“éš”æ•¸å­—ï¼Œå€˜é°™é°¡ç©ºé±‚ä»¥æœ€å°é–“éš”å€¼é®¦æ­¥å”·ğŸ’‹"} default answer ("") with title Â¬
					{"é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥"}
				set RT_Seconds to ((text returned of the result) as integer)
				if RT_Seconds is "" then return continue quit
				set firstRun to false
			else
				try
					do shell script (rsyncPath & rsyncParameter & SyncSource & space & SyncDest)
				end try
			end if
			if firstRun is "" then return seconds
			if RT_Option is "ç§’" then return RT_Seconds
			if RT_Option is "é­µ" then return {RT_Seconds * minutes}
			if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
			if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
			if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
	end try
end idle
------------------------ é–‹å•Ÿè…³æœ¬ ------------------------ON. 
script OpenScript
	try
		set OpenAppScript to POSIX path of (path to me as text) & ("Contents/Resources/Scripts/main.scpt")
		set OpenAppScript to quoted form of OpenAppScript
		do shell script ("open " & OpenAppScript)
		set TerminalNotifier to POSIX path of (path to me as text) & ("Contents/MacOS/terminal-notifier")
		set TerminalNotifier to quoted form of TerminalNotifier
		do shell script (TerminalNotifier & " -title iCloudDriveè…³æœ¬å·²é–‹å•Ÿé°³å”·ğŸ’‹")
		continue quit
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
------------------------------âˆ é±«é°°iCloudDriveæ–‡ä»¶å¤¾é®¦æ­¥ âˆ--------------------------------END. 


-- 
